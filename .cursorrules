// Cursor project rules for running Wear OS E2E tests

rules:
  - id: wearos-e2e-tests
    description: >
      How agents should prepare and execute Wear OS UIAutomator-based E2E tests,
      and how to interpret their results.
    appliesTo:
      - "**/*"
    priority: high
    recommendations:
      - >
        To run Wear OS E2E tests, always execute commands from the project root
        (`C:\\Users\\gabri\\Documents\\MyWorkoutAssistant`), not from a module
        subdirectory.
      - >
        Before running any connected Android tests, ensure at least one Wear OS
        emulator or physical watch is online:
        1) Run `adb devices`.
        2) Verify there is at least one entry with state `device` (not `offline`
           or `unauthorized`).
      - >
        Prefer using the helper scripts when triggering Wear E2E tests:
        - Windows/PowerShell: `pwsh ./scripts/run_wear_e2e.ps1`
        - Unix shells: `bash ./scripts/run_wear_e2e.sh`
        These scripts perform the `adb devices` check and then invoke Gradle.
      - >
        The helper scripts support running individual tests or subsets:
        - Full suite (all tests): `pwsh ./scripts/run_wear_e2e.ps1` or `bash ./scripts/run_wear_e2e.sh`
        - Smoke-only suite: `pwsh ./scripts/run_wear_e2e.ps1 -SmokeOnly` or `bash ./scripts/run_wear_e2e.sh --smoke-only`
        - Single test class: `pwsh ./scripts/run_wear_e2e.ps1 -TestClass WorkoutSelectionE2ETest` or `bash ./scripts/run_wear_e2e.sh --test-class WorkoutSelectionE2ETest`
        - Multiple test classes (comma-separated): `pwsh ./scripts/run_wear_e2e.ps1 -TestClass "SmokeE2ETest,WorkoutSelectionE2ETest"` or `bash ./scripts/run_wear_e2e.sh --test-class "SmokeE2ETest,WorkoutSelectionE2ETest"`
        - Single test method: `pwsh ./scripts/run_wear_e2e.ps1 -TestClass WorkoutSelectionE2ETest -TestMethod launch_showsHeaderAndWorkouts` or `bash ./scripts/run_wear_e2e.sh --test-class WorkoutSelectionE2ETest --test-method launch_showsHeaderAndWorkouts`
        - Available test classes: SmokeE2ETest, WorkoutSelectionE2ETest, WorkoutDetailE2ETest, WorkoutInProgressE2ETest, WorkoutCompleteE2ETest
        - You can use short class names (e.g., `WorkoutSelectionE2ETest`) or full qualified names (e.g., `com.gabstra.myworkoutassistant.e2e.WorkoutSelectionE2ETest`)
      - >
        If you need to run Gradle directly, use:
        - Full debug Wear E2E suite on all connected devices:
          `./gradlew :wearos:connectedDebugAndroidTest`
        - Optional release (near-production) suite:
          `./gradlew :wearos:connectedReleaseAndroidTest`
        - Single test class:
          `./gradlew :wearos:connectedDebugAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.gabstra.myworkoutassistant.e2e.SmokeE2ETest`
        - Single test method:
          `./gradlew :wearos:connectedDebugAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.gabstra.myworkoutassistant.e2e.SmokeE2ETest#launchApp_fromHome`
        - Multiple test classes (comma-separated):
          `./gradlew :wearos:connectedDebugAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.gabstra.myworkoutassistant.e2e.SmokeE2ETest,com.gabstra.myworkoutassistant.e2e.WorkoutSelectionE2ETest`
      - >
        Treat a non-zero Gradle exit code from any `connected*AndroidTest` task
        as an E2E test failure. Do not attempt to ignore or auto-retry without
        inspecting the failure.
      - >
        To interpret detailed E2E results, read the JUnit XML output from:
        - `wearos/build/outputs/androidTest-results/`
        - or `wearos/build/test-results/connected/`
        Summarize: number of tests, failures, and the first few failure messages.
      - >
        After running E2E tests (especially if they fail), ALWAYS inspect the device
        logs that were automatically captured during test execution. The helper scripts
        (`run_wear_e2e.ps1` and `run_wear_e2e.sh`) automatically capture logcat logs
        to timestamped files in `wearos/build/e2e-logs/` (e.g., `logcat_20241220_143022.txt`).
        The script output will display the exact log file path after test completion.
        Read the log file to identify:
        - Application crashes or exceptions (look for FATAL, ERROR, or Exception stack traces)
        - UI interaction issues (look for UIAutomator-related errors)
        - Permission or system dialog issues
        - App-specific errors from the package `com.gabstra.myworkoutassistant`
        - Any relevant debug information that might explain test failures
        When reporting test results, include relevant excerpts from the logs, especially
        error messages and stack traces that correlate with test failures.
      - >
        The main E2E test class for quick health checks is
        `com.gabstra.myworkoutassistant.e2e.SmokeE2ETest`
        (under `wearos/src/androidTest/java`). Use this when asked to run a
        "smoke" or "basic" Wear E2E test.
      - >
        If `connectedDebugAndroidTest` fails with "No online devices found" or
        "Device is OFFLINE", do not modify code. Instruct the user to start a
        Wear OS emulator or connect their watch and confirm `adb devices`
        shows at least one `device` before retrying.

  - id: coding-conventions
    description: >
      Always follow good coding conventions and best practices when writing code.
    appliesTo:
      - "**/*.kt"
      - "**/*.java"
      - "**/*.xml"
      - "**/*.gradle*"
    priority: high
    recommendations:
      - >
        Follow DRY (Don't Repeat Yourself) principles - extract repeated code
        into reusable functions, classes, or utilities.
      - >
        Use meaningful variable and function names that clearly express their
        purpose and intent.
      - >
        Keep functions focused and single-purpose - avoid functions that do
        multiple unrelated things.
      - >
        Follow Kotlin coding conventions as defined in the official Kotlin
        style guide (https://kotlinlang.org/docs/coding-conventions.html).
      - >
        Use appropriate design patterns and architectural principles (e.g.,
        MVVM, Repository pattern) consistently throughout the codebase.
      - >
        Write clean, readable code with appropriate comments where necessary,
        but prefer self-documenting code over excessive comments.
      - >
        Handle errors appropriately - use try-catch blocks, nullable types,
        and Result types where appropriate.
      - >
        Maintain consistency with existing codebase patterns and conventions.

  - id: build-and-fix-compilation
    description: >
      Always build the project and fix any compilation errors after making
      code changes.
    appliesTo:
      - "**/*.kt"
      - "**/*.java"
      - "**/*.xml"
      - "**/*.gradle*"
    priority: high
    recommendations:
      - >
        After making any code changes, ALWAYS run a build to verify compilation:
        - For Android projects: `./gradlew build` or `./gradlew assembleDebug`
        - For specific modules: `./gradlew :module:build`
      - >
        If compilation errors are found, fix them immediately before proceeding
        with other tasks or reporting completion.
      - >
        Do not leave code in a broken or uncompilable state. All code changes
        must result in a successfully compiling project.
      - >
        Check for both Kotlin and Java compilation errors, as well as resource
        and manifest errors.
      - >
        If build errors persist after attempts to fix them, clearly report
        the specific errors and their locations to the user rather than
        leaving the code in a broken state.
      - >
        Use `read_lints` tool to check for linter errors after code changes
        and address any issues found.

  - id: logging-conventions
    description: >
      All debugging logs must use the Android Log library with a consistent
      tag for easy filtering.
    appliesTo:
      - "**/*.kt"
      - "**/*.java"
    priority: high
    recommendations:
      - >
        All debugging logs MUST use android.util.Log (import as `Log`).
        Do not use println(), System.out.println(), or any other logging
        mechanism for debugging purposes.
      - >
        Each class that logs must define a companion object constant named
        `TAG` with the class name as the value. For example:
        `companion object { private const val TAG = "WorkoutViewModel" }`
        In Java, use: `private static final String TAG = "WorkoutViewModel";`
      - >
        Always use the TAG constant when calling Log methods:
        - `Log.d(TAG, "message")` for debug logs
        - `Log.e(TAG, "message")` for error logs
        - `Log.w(TAG, "message")` for warning logs
        - `Log.i(TAG, "message")` for info logs
        - `Log.v(TAG, "message")` for verbose logs
      - >
        Never hardcode tag strings directly in Log calls. Always use the
        TAG constant to ensure consistent filtering across the codebase.
      - >
        The TAG should match the class name (without package) for easy
        identification when filtering logs with `adb logcat -s TAG_NAME`.


